<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reseller CMD | Digital Allies</title>
    <!-- 
    Chosen Palette: "Digital Professional" - A base of Slate-50 for a clean, non-distracting canvas. 
    Indigo-600 acts as the primary action color to drive focus. Emerald-500 signifies profit/growth, 
    while Rose-500 highlights capital "trapped" in inventory. This high-contrast but 
    minimalist palette reduces cognitive load (Anti-Burnout).
    -->
    <!-- 
    Application Structure Plan: 
    1. Navigation: A bottom-fixed mobile-style dock for quick switching between Dashboard and List.
    2. Dashboard: High-level financial visualization (Canvas Chart) and a "Quick Log" form to minimize data entry friction.
    3. Inventory List: A detailed view with status toggles, platform tags, and categorical grouping.
    4. Export: A dedicated utility section to generate CSVs formatted for platform bulk-imports.
    Rationale: This flow prioritizes the "30-second habit" (adding items) while giving immediate visual rewards for sales.
    -->
    <!-- 
    Visualization & Content Choices:
    - Financial Health: Doughnut Chart (Chart.js via Canvas) comparing Profit vs. Invested Capital.
    - Status Indicators: Unicode Emojis (ðŸ’°, â³, ðŸ“¸) + CSS background colors for instant recognition.
    - Data Table: Responsive Flex-layout "cards" instead of heavy tables for mobile consumption.
    - NO SVG: All icons are rendered via Unicode symbols or styled HTML/CSS elements.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        .chart-container { position: relative; width: 100%; max-width: 300px; margin: 0 auto; height: 250px; }
        input, select { font-size: 16px !important; } /* Prevents iOS zoom on focus */
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="module" data-type="babel">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'reseller-app-v1';

        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [inventory, setInventory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Form State
            const [name, setName] = useState('');
            const [cost, setCost] = useState('');
            const [platform, setPlatform] = useState('eBay');
            const [category, setCategory] = useState('Clothing');

            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = `/artifacts/${appId}/users/${user.uid}/inventory`;
                const q = query(collection(db, path));
                return onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setInventory(data.sort((a, b) => b.createdAt - a.createdAt));
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    setLoading(false);
                });
            }, [user]);

            const stats = useMemo(() => {
                return inventory.reduce((acc, item) => {
                    if (item.status === 'ðŸ’° Sold') {
                        acc.profit += (item.soldPrice - (item.fees || 0) - item.cost);
                    } else {
                        acc.invested += item.cost;
                    }
                    return acc;
                }, { profit: 0, invested: 0 });
            }, [inventory]);

            useEffect(() => {
                if (view === 'dashboard' && chartRef.current && !loading) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Invested', 'Profit'],
                            datasets: [{
                                data: [stats.invested, stats.profit],
                                backgroundColor: ['#f43f5e', '#10b981'],
                                borderWidth: 0,
                                cutout: '80%'
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }, [view, loading, stats]);

            const addItem = async (e) => {
                e.preventDefault();
                if (!name || !cost) return;
                const path = `/artifacts/${appId}/users/${user.uid}/inventory`;
                await addDoc(collection(db, path), {
                    name, cost: parseFloat(cost), platform, category,
                    status: 'â³ Listed', listPrice: parseFloat(cost) * 3,
                    soldPrice: 0, fees: 0, createdAt: Date.now()
                });
                setName(''); setCost('');
            };

            const markSold = async (item) => {
                const sp = prompt("Final Sale Price?", item.listPrice);
                if (!sp) return;
                const sold = parseFloat(sp);
                const path = `/artifacts/${appId}/users/${user.uid}/inventory`;
                const itemRef = doc(db, path, item.id);
                await setDoc(itemRef, {
                    status: 'ðŸ’° Sold', soldPrice: sold, fees: (sold * 0.13) + 0.30
                }, { merge: true });
            };

            const exportCSV = () => {
                const headers = ["Item", "Status", "Platform", "Category", "Cost", "List Price", "Sold Price", "Profit"];
                const rows = inventory.map(i => [
                    i.name, i.status, i.platform, i.category, i.cost, i.listPrice, i.soldPrice,
                    i.soldPrice ? (i.soldPrice - i.fees - i.cost).toFixed(2) : 0
                ]);
                const csv = [headers, ...rows].map(r => r.join(",")).join("\n");
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_${new Date().toLocaleDateString()}.csv`;
                a.click();
            };

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-white">
                    <div className="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
                    <p className="mt-4 text-[10px] font-black tracking-widest text-slate-400">SYNCING CLOUD DATA</p>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen pb-32">
                    {/* Top Bar */}
                    <div className="px-6 py-8 flex justify-between items-end">
                        <div>
                            <p className="text-[10px] font-black text-slate-400 tracking-widest uppercase">Reseller Command</p>
                            <h1 className="text-2xl font-black text-slate-900 tracking-tighter">Inventory App</h1>
                        </div>
                        <button onClick={exportCSV} className="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-wider shadow-sm hover:bg-slate-50 transition-colors">
                            Export â¤“
                        </button>
                    </div>

                    {view === 'dashboard' ? (
                        <div className="px-6 space-y-8 animate-in fade-in duration-500">
                            {/* Dashboard Visualization */}
                            <div className="bg-white p-8 rounded-[3rem] border border-slate-200 shadow-sm relative">
                                <div className="chart-container">
                                    <canvas ref={chartRef}></canvas>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Profit</p>
                                        <p className="text-3xl font-black text-slate-900">${stats.profit.toFixed(0)}</p>
                                    </div>
                                </div>
                                <div className="mt-8 grid grid-cols-2 gap-4">
                                    <div className="text-center">
                                        <p className="text-[10px] font-black text-rose-500 uppercase tracking-widest">Invested</p>
                                        <p className="text-lg font-black text-slate-800">${stats.invested.toFixed(0)}</p>
                                    </div>
                                    <div className="text-center border-l border-slate-100">
                                        <p className="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Items Sold</p>
                                        <p className="text-lg font-black text-slate-800">{inventory.filter(i => i.status === 'ðŸ’° Sold').length}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Add Form */}
                            <form onSubmit={addItem} className="bg-indigo-600 p-8 rounded-[3rem] shadow-xl shadow-indigo-100 space-y-4">
                                <h3 className="text-white text-[10px] font-black uppercase tracking-[0.2em] mb-4">Quick Entry âœš</h3>
                                <input 
                                    value={name} onChange={e => setName(e.target.value)}
                                    placeholder="Item name..."
                                    className="w-full bg-white/10 border border-white/20 rounded-2xl px-5 py-4 text-white placeholder:text-white/40 focus:bg-white/20 outline-none transition-all"
                                />
                                <div className="flex gap-3">
                                    <input 
                                        type="number" value={cost} onChange={e => setCost(e.target.value)}
                                        placeholder="Cost $"
                                        className="flex-1 bg-white/10 border border-white/20 rounded-2xl px-5 py-4 text-white placeholder:text-white/40 focus:bg-white/20 outline-none transition-all"
                                    />
                                    <button className="bg-white text-indigo-600 px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest hover:scale-105 active:scale-95 transition-transform">
                                        Log
                                    </button>
                                </div>
                                <div className="grid grid-cols-2 gap-3 pt-2">
                                    <select value={platform} onChange={e => setPlatform(e.target.value)} className="bg-white/5 border border-white/10 text-white/80 rounded-xl px-3 py-2 text-[10px] font-black uppercase">
                                        <option value="eBay">eBay</option>
                                        <option value="Depop">Depop</option>
                                        <option value="Marketplace">FB Market</option>
                                    </select>
                                    <select value={category} onChange={e => setCategory(e.target.value)} className="bg-white/5 border border-white/10 text-white/80 rounded-xl px-3 py-2 text-[10px] font-black uppercase">
                                        <option value="Clothing">Clothing</option>
                                        <option value="Housewares">Home</option>
                                        <option value="Tech">Tech</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                    ) : (
                        <div className="px-6 space-y-4 animate-in fade-in duration-500">
                            <div className="flex justify-between items-center px-2">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Live Stock ({inventory.length})</h3>
                                <div className="flex gap-1">
                                    <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                    <p className="text-[8px] font-bold text-slate-300">CLOUD SYNCED</p>
                                </div>
                            </div>
                            
                            <div className="space-y-3">
                                {inventory.map(item => (
                                    <div key={item.id} className="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm flex items-center justify-between group">
                                        <div className="flex-1 min-w-0 pr-4">
                                            <h4 className="font-bold text-slate-800 truncate leading-tight">{item.name}</h4>
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                <span className="text-[9px] font-black text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded uppercase tracking-tighter">{item.platform}</span>
                                                <span className={`text-[9px] font-black px-2 py-0.5 rounded uppercase tracking-tighter ${item.status === 'ðŸ’° Sold' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>
                                                    {item.status}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        {item.status === 'ðŸ’° Sold' ? (
                                            <div className="text-right">
                                                <p className="text-sm font-black text-emerald-600">+${(item.soldPrice - item.fees - item.cost).toFixed(2)}</p>
                                                <p className="text-[8px] font-black text-slate-300 uppercase tracking-widest">Profit</p>
                                            </div>
                                        ) : (
                                            <button onClick={() => markSold(item)} className="bg-slate-900 text-white w-12 h-12 rounded-2xl flex items-center justify-center font-black text-lg shadow-lg hover:scale-110 active:scale-95 transition-all">
                                                $
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Navbar */}
                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 glass border border-slate-200 h-20 rounded-[2.5rem] shadow-2xl flex items-center px-4 gap-2 z-50">
                        <button 
                            onClick={() => setView('dashboard')}
                            className={`flex items-center gap-2 px-6 py-3 rounded-[2rem] transition-all ${view === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-400 hover:bg-slate-50'}`}
                        >
                            <span className="text-lg">âœ¦</span>
                            <span className="text-[10px] font-black uppercase tracking-widest">Dash</span>
                        </button>
                        <button 
                            onClick={() => setView('inventory')}
                            className={`flex items-center gap-2 px-6 py-3 rounded-[2rem] transition-all ${view === 'inventory' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-400 hover:bg-slate-50'}`}
                        >
                            <span className="text-lg">â˜°</span>
                            <span className="text-[10px] font-black uppercase tracking-widest">Stock</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

